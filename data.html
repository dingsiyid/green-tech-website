<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>数据与可视化 - 绿色未来</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: {
                            DEFAULT: '#2e7d32',
                            light: '#4caf50',
                            dark: '#1b5e20'
                        },
                        secondary: '#8bc34a',
                        accent: '#ffc107',
                        light: '#f5f9f5'
                    }
                }
            }
        }
    </script>
    <style>
        .page-transition {
            animation: fadeIn 0.5s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* 地图样式 */
        .map-container {
            position: relative;
            border-radius: 0.5rem;
            overflow: hidden;
            height: 70vh;
            min-height: 500px;
            background-color: #e5e7eb;
        }
        
        #worldMap {
            width: 100%;
            height: 100%;
            z-index: 1;
        }
        
        .map-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.1);
            pointer-events: none;
            z-index: 2;
        }
        
        .map-legend {
            background: white;
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.2);
            z-index: 1000;
        }
        
        .legend-color {
            width: 20px;
            height: 20px;
            display: inline-block;
            margin-right: 5px;
            border-radius: 3px;
        }
        
        .data-tooltip {
            position: absolute;
            background: white;
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            z-index: 1000;
            max-width: 200px;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        .data-tooltip.visible {
            opacity: 1;
        }
        
        .custom-popup .leaflet-popup-content-wrapper {
            border-radius: 8px;
            box-shadow: 0 3px 14px rgba(0,0,0,0.4);
        }
        
        .custom-popup .leaflet-popup-content {
            margin: 12px 15px;
            font-size: 14px;
        }
        
        .map-error {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            text-align: center;
            padding: 20px;
            background: #f8f9fa;
            color: #6c757d;
        }
        
        .map-error i {
            font-size: 3rem;
            margin-bottom: 1rem;
            color: #6c757d;
        }
        
        .map-loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            text-align: center;
            padding: 20px;
            background: #f8f9fa;
            color: #6c757d;
        }
        
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: #2e7d32;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin-bottom: 1rem;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .fallback-map {
            width: 100%;
            height: 100%;
            background: linear-gradient(to bottom, #a8d5e5 0%, #74b9d3 100%);
            position: relative;
            overflow: hidden;
        }
        
        .fallback-continents {
            position: absolute;
            width: 100%;
            height: 100%;
        }
        
        .continent {
            position: absolute;
            background-color: #4a9cc5;
            border-radius: 50%;
            opacity: 0.7;
        }
        
        .fallback-marker {
            position: absolute;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            transform: translate(-50%, -50%);
            cursor: pointer;
            box-shadow: 0 0 0 2px white, 0 0 5px rgba(0,0,0,0.5);
            transition: all 0.3s ease;
        }
        
        .fallback-marker:hover {
            transform: translate(-50%, -50%) scale(1.5);
            z-index: 10;
        }
        
        .map-source-selector {
            position: absolute;
            top: 10px;
            left: 10px;
            background: white;
            padding: 8px;
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(0,0,0,0.2);
            z-index: 1000;
        }
        
        .card-hover {
            transition: all 0.3s ease;
        }
        
        .card-hover:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
    </style>
</head>
<body class="bg-light text-gray-800">
    <!-- 导航栏 -->
    <header class="bg-white shadow-md sticky top-0 z-50">
        <nav class="container mx-auto px-4 py-3 flex justify-between items-center">
            <div class="flex items-center space-x-2">
                <i class="fas fa-leaf text-2xl text-primary"></i>
                <span class="text-xl font-bold text-primary">绿色未来</span>
            </div>
            
            <!-- 桌面导航 -->
            <ul class="hidden md:flex space-x-6">
                <li><a href="index.html" class="font-medium transition-colors text-gray-700 hover:text-primary">首页</a></li>
                <li><a href="news.html" class="font-medium transition-colors text-gray-700 hover:text-primary">新闻与趋势</a></li>
                <li><a href="knowledge.html" class="font-medium transition-colors text-gray-700 hover:text-primary">绿色科技知识库</a></li>
                <li><a href="projects.html" class="font-medium transition-colors text-gray-700 hover:text-primary">项目与案例</a></li>
                <li><a href="data.html" class="font-medium transition-colors text-primary border-b-2 border-primary">数据与可视化</a></li>
                <li><a href="#footer" class="font-medium transition-colors text-gray-700 hover:text-primary">关于我们</a></li>
            </ul>
            
            <!-- 移动端菜单按钮 -->
            <button onclick="toggleMenu()" class="md:hidden text-gray-700">
                <i class="fas fa-bars text-xl"></i>
            </button>
        </nav>
        
        <!-- 移动端导航菜单 -->
        <div id="mobileMenu" class="hidden md:hidden bg-white shadow-lg">
            <ul class="py-2">
                <li><a href="index.html" class="block px-4 py-2 font-medium text-gray-700 hover:bg-light hover:text-primary">首页</a></li>
                <li><a href="news.html" class="block px-4 py-2 font-medium text-gray-700 hover:bg-light hover:text-primary">新闻与趋势</a></li>
                <li><a href="knowledge.html" class="block px-4 py-2 font-medium text-gray-700 hover:bg-light hover:text-primary">绿色科技知识库</a></li>
                <li><a href="projects.html" class="block px-4 py-2 font-medium text-gray-700 hover:bg-light hover:text-primary">项目与案例</a></li>
                <li><a href="data.html" class="block px-4 py-2 font-medium text-primary bg-light">数据与可视化</a></li>
                <li><a href="#footer" class="block px-4 py-2 font-medium text-gray-700 hover:bg-light hover:text-primary">关于我们</a></li>
            </ul>
        </div>
    </header>

    <!-- 主要内容区 -->
    <main class="min-h-screen page-transition">
        <div id="app">
            <div class="container mx-auto px-4 py-8">
                <h2 class="text-2xl md:text-3xl font-bold text-center text-primary mb-12">
                    全球环境数据可视化 2024
                </h2>
                
                <!-- 数据概览卡片 -->
                <section class="mb-12">
                    <h3 class="text-xl font-bold text-primary mb-6 flex items-center">
                        <i class="fas fa-globe-americas mr-3"></i>全球环境概览 2024
                    </h3>
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                        <div class="bg-white rounded-xl shadow-md p-6 card-hover border-l-4 border-green-500">
                            <div class="flex items-center mb-4">
                                <i class="fas fa-industry text-2xl text-green-500 mr-3"></i>
                                <h3 class="text-lg font-semibold text-gray-700">全球碳排放量</h3>
                            </div>
                            <p class="text-3xl font-bold text-gray-800">382 亿吨</p>
                            <p class="text-sm text-red-500 mt-2">
                                <i class="fas fa-arrow-up mr-1"></i>较2023年增长1.8%
                            </p>
                        </div>
                        
                        <div class="bg-white rounded-xl shadow-md p-6 card-hover border-l-4 border-primary">
                            <div class="flex items-center mb-4">
                                <i class="fas fa-leaf text-2xl text-primary mr-3"></i>
                                <h3 class="text-lg font-semibold text-gray-700">可再生能源占比</h3>
                            </div>
                            <p class="text-3xl font-bold text-gray-800">34.2%</p>
                            <p class="text-sm text-green-500 mt-2">
                                <i class="fas fa-arrow-up mr-1"></i>较2023年增长3.2%
                            </p>
                        </div>
                        
                        <div class="bg-white rounded-xl shadow-md p-6 card-hover border-l-4 border-secondary">
                            <div class="flex items-center mb-4">
                                <i class="fas fa-city text-2xl text-secondary mr-3"></i>
                                <h3 class="text-lg font-semibold text-gray-700">平均绿色指数</h3>
                            </div>
                            <p class="text-3xl font-bold text-gray-800">75.8</p>
                            <p class="text-sm text-green-500 mt-2">
                                <i class="fas fa-arrow-up mr-1"></i>较2023年增长2.1%
                            </p>
                        </div>
                    </div>
                    
                    <!-- 碳排放图表 -->
                    <div class="bg-white rounded-xl shadow-md p-6">
                        <h3 class="text-xl font-bold text-primary mb-4">主要国家碳排放量（百万吨）- 2024</h3>
                        <div class="h-80">
                            <canvas id="emissionsChart"></canvas>
                        </div>
                    </div>
                </section>
                
                <!-- 可再生能源趋势 -->
                <section class="mb-12">
                    <h3 class="text-xl font-bold text-primary mb-6 flex items-center">
                        <i class="fas fa-chart-line mr-3"></i>可再生能源利用趋势 2024
                    </h3>
                    
                    <div class="bg-white rounded-xl shadow-md p-6">
                        <h3 class="text-xl font-bold text-primary mb-4">全球可再生能源发电占比 (%) 2018-2024</h3>
                        <div class="h-80">
                            <canvas id="renewableChart"></canvas>
                        </div>
                    </div>
                </section>
                
                <!-- 城市绿色指数排名 -->
                <section class="mb-12">
                    <h3 class="text-xl font-bold text-primary mb-6 flex items-center">
                        <i class="fas fa-trophy mr-3"></i>城市绿色指数排名 2024
                    </h3>
                    
                    <div class="bg-white rounded-xl shadow-md p-6 overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead>
                                <tr>
                                    <th class="px-4 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">排名</th>
                                    <th class="px-4 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">城市</th>
                                    <th class="px-4 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">国家</th>
                                    <th class="px-4 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">绿色指数</th>
                                    <th class="px-4 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">碳排放 (吨/人)</th>
                                    <th class="px-4 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">可再生能源占比</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                                <tr v-for="(city, index) in cityRankings" :key="city.name" class="hover:bg-gray-50">
                                    <td class="px-4 py-3 whitespace-nowrap">
                                        <span class="px-2 py-1 text-xs font-bold rounded-full" 
                                              :class="getRankingClass(index+1)">
                                            {{ index+1 }}
                                        </span>
                                    </td>
                                    <td class="px-4 py-3 whitespace-nowrap font-medium text-gray-900">{{ city.name }}</td>
                                    <td class="px-4 py-3 whitespace-nowrap text-gray-700">{{ city.country }}</td>
                                    <td class="px-4 py-3 whitespace-nowrap">
                                        <div class="flex items-center">
                                            <div class="w-16 bg-gray-200 rounded-full h-2 mr-2">
                                                <div class="bg-primary h-2 rounded-full" :style="{width: city.greenIndex + '%'}"></div>
                                            </div>
                                            <span class="font-medium">{{ city.greenIndex }}</span>
                                        </div>
                                    </td>
                                    <td class="px-4 py-3 whitespace-nowrap text-gray-700">{{ city.emissions }}</td>
                                    <td class="px-4 py-3 whitespace-nowrap">
                                        <div class="flex items-center">
                                            <div class="w-16 bg-gray-200 rounded-full h-2 mr-2">
                                                <div class="bg-secondary h-2 rounded-full" :style="{width: city.renewable + '%'}"></div>
                                            </div>
                                            <span class="font-medium">{{ city.renewable }}%</span>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </section>
                
                <!-- 全球环境数据交互式地图 -->
                <section>
                    <h3 class="text-xl font-bold text-primary mb-6 flex items-center">
                        <i class="fas fa-map mr-3"></i>全球环境数据交互式地图 2024
                    </h3>
                    
                    <div class="bg-white rounded-xl shadow-md p-6">
                        <div class="flex flex-wrap gap-4 mb-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">选择数据类型</label>
                                <select v-model="selectedDataType" @change="updateMap" class="rounded-lg border-gray-300 shadow-sm focus:border-primary focus:ring-primary">
                                    <option value="emissions">碳排放</option>
                                    <option value="renewable">可再生能源</option>
                                    <option value="greenIndex">绿色指数</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="rounded-lg overflow-hidden relative map-container">
                            <!-- Leaflet 地图容器 -->
                            <div id="worldMap">
                                <!-- 加载状态 -->
                                <div v-if="mapState === 'loading'" class="map-loading">
                                    <div class="spinner"></div>
                                    <p>正在加载地图数据...</p>
                                </div>
                                
                                <!-- 错误状态 -->
                                <div v-else-if="mapState === 'error'" class="map-error">
                                    <i class="fas fa-exclamation-triangle"></i>
                                    <h3 class="text-xl font-bold mb-2">地图加载失败</h3>
                                    <p class="mb-4">无法加载交互式地图。请检查您的网络连接或稍后重试。</p>
                                    <button @click="initMap" class="bg-primary hover:bg-primary-dark text-white font-medium py-2 px-4 rounded-lg transition duration-200">
                                        <i class="fas fa-redo mr-2"></i>重新加载地图
                                    </button>
                                </div>
                                
                                <!-- 备用地图 -->
                                <div v-else-if="mapState === 'fallback'" class="fallback-map">
                                    <div class="fallback-continents">
                                        <div class="continent" style="width: 30%; height: 40%; top: 15%; left: 15%;"></div>
                                        <div class="continent" style="width: 25%; height: 35%; top: 20%; left: 60%;"></div>
                                        <div class="continent" style="width: 35%; height: 30%; top: 50%; left: 20%;"></div>
                                        <div class="continent" style="width: 20%; height: 25%; top: 60%; left: 70%;"></div>
                                    </div>
                                    
                                    <!-- 备用标记 -->
                                    <div v-for="point in mapDataPoints" 
                                         :key="point.name"
                                         class="fallback-marker"
                                         :style="{
                                             left: getFallbackX(point.lng) + '%',
                                             top: getFallbackY(point.lat) + '%',
                                             backgroundColor: getColorByValue(point[selectedDataType], selectedDataType)
                                         }"
                                         @mouseover="showTooltip(point, $event)"
                                         @mouseout="hideTooltip">
                                    </div>
                                    
                                    <!-- 工具提示 -->
                                    <div class="data-tooltip" :class="{ visible: tooltip.visible }" 
                                         :style="{ left: tooltip.x + 'px', top: tooltip.y + 'px' }">
                                        <h4 class="font-bold">{{ tooltip.name }}, {{ tooltip.country }}</h4>
                                        <p>碳排放: {{ tooltip.emissions }} 吨/人</p>
                                        <p>可再生能源: {{ tooltip.renewable }}%</p>
                                        <p>绿色指数: {{ tooltip.greenIndex }}</p>
                                        <p class="text-xs text-gray-500 mt-1">2024年数据</p>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 地图源选择器 -->
                            <div v-if="mapState === 'loaded'" class="map-source-selector">
                                <label class="block text-xs font-medium text-gray-700 mb-1">地图源</label>
                                <select v-model="selectedMapSource" @change="changeMapSource" class="text-xs rounded border-gray-300 shadow-sm focus:border-primary focus:ring-primary">
                                    <option value="osm">OpenStreetMap</option>
                                    <option value="carto">CartoDB Light</option>
                                    <option value="stadia">Stadia Alidade</option>
                                    <option value="esri">Esri World Imagery</option>
                                </select>
                            </div>
                            
                            <div class="map-overlay"></div>
                            
                            <!-- 地图图例 -->
                            <div class="map-legend absolute bottom-4 right-4">
                                <h4 class="text-sm font-semibold mb-2">{{ getLegendTitle() }}</h4>
                                <div v-for="item in legendItems" :key="item.label" class="flex items-center mb-1">
                                    <div class="legend-color" :style="{backgroundColor: item.color}"></div>
                                    <span class="text-xs">{{ item.label }}</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mt-4 text-sm text-gray-600">
                            <p v-if="mapState === 'loaded'">点击地图上的标记查看各城市2024年详细环境数据</p>
                            <p v-else-if="mapState === 'fallback'">将鼠标悬停在地图标记上查看各城市2024年详细环境数据</p>
                            <p v-else>地图当前不可用。请尝试重新加载页面。</p>
                        </div>
                    </div>
                </section>
            </div>
        </div>
    </main>

    <!-- 页脚 -->
    <footer id="footer" class="bg-primary-dark text-white pt-12 pb-6 mt-12">
        <div class="container mx-auto px-4">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-8 mb-8">
                <div>
                    <h3 class="text-xl font-bold mb-4 relative pb-2">
                        关于我们
                        <span class="absolute bottom-0 left-0 w-10 h-1 bg-accent"></span>
                    </h3>
                    <p class="text-gray-300 mb-4">
                        绿色未来是一个致力于推广可持续发展理念和绿色科技创新的平台。我们通过提供最新资讯、知识科普和案例分析，帮助公众、企业和政府更好地理解和参与环保行动。
                    </p>
                    <div class="flex space-x-4">
                        <a href="#" class="w-10 h-10 bg-primary rounded-full flex items-center justify-center hover:bg-accent transition-colors">
                            <i class="fab fa-weibo"></i>
                        </a>
                        <a href="#" class="w-10 h-10 bg-primary rounded-full flex items-center justify-center hover:bg-accent transition-colors">
                            <i class="fab fa-weixin"></i>
                        </a>
                        <a href="#" class="w-10 h-10 bg-primary rounded-full flex items-center justify-center hover:bg-accent transition-colors">
                            <i class="fab fa-twitter"></i>
                        </a>
                        <a href="#" class="w-10 h-10 bg-primary rounded-full flex items-center justify-center hover:bg-accent transition-colors">
                            <i class="fab fa-linkedin"></i>
                        </a>
                    </div>
                </div>
                
                <div>
                    <h3 class="text-xl font-bold mb-4 relative pb-2">
                        快速链接
                        <span class="absolute bottom-0 left-0 w-10 h-1 bg-accent"></span>
                    </h3>
                    <ul class="space-y-2">
                        <li><a href="index.html" class="text-gray-300 hover:text-accent transition-colors">首页</a></li>
                        <li><a href="news.html" class="text-gray-300 hover:text-accent transition-colors">新闻与趋势</a></li>
                        <li><a href="knowledge.html" class="text-gray-300 hover:text-accent transition-colors">绿色科技知识库</a></li>
                        <li><a href="projects.html" class="text-gray-300 hover:text-accent transition-colors">项目与案例</a></li>
                        <li><a href="data.html" class="text-gray-300 hover:text-accent transition-colors">数据与可视化</a></li>
                    </ul>
                </div>
                
                <div>
                    <h3 class="text-xl font-bold mb-4 relative pb-2">
                        联系我们
                        <span class="absolute bottom-0 left-0 w-10 h-1 bg-accent"></span>
                    </h3>
                    <ul class="space-y-3 text-gray-300">
                        <li class="flex items-center">
                            <i class="fas fa-map-marker-alt mr-3 text-accent"></i>
                            <span>北京市朝阳区绿色科技园区</span>
                        </li>
                        <li class="flex items-center">
                            <i class="fas fa-phone mr-3 text-accent"></i>
                            <span>400-123-4567</span>
                        </li>
                        <li class="flex items-center">
                            <i class="fas fa-envelope mr-3 text-accent"></i>
                            <span>contact@greenfuture.org</span>
                        </li>
                        <li class="flex items-center">
                            <i class="fas fa-clock mr-3 text-accent"></i>
                            <span>周一至周五 9:00-18:00</span>
                        </li>
                    </ul>
                </div>
            </div>
            
            <div class="pt-6 border-t border-gray-700 text-center text-gray-400">
                <p>&copy; 2023 绿色未来 - 可持续发展平台. 保留所有权利.</p>
            </div>
        </div>
    </footer>

    <script>
        const { createApp, ref, onMounted, computed, watch } = Vue;
        
        createApp({
            setup() {
                // 响应式数据
                const selectedDataType = ref('emissions');
                const selectedMapSource = ref('osm');
                const mapState = ref('loading');
                const tooltip = ref({
                    visible: false,
                    x: 0,
                    y: 0,
                    name: '',
                    country: '',
                    emissions: 0,
                    renewable: 0,
                    greenIndex: 0
                });
                
                // 地图引用
                let worldMap = null;
                let currentTileLayer = null;
                let cityMarkers = [];
                
                // 定义多个地图源
                const mapSources = {
                    osm: {
                        name: 'OpenStreetMap',
                        url: 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
                        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
                    },
                    carto: {
                        name: 'CartoDB Light',
                        url: 'https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png',
                        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, &copy; <a href="https://carto.com/attributions">CARTO</a>'
                    },
                    stadia: {
                        name: 'Stadia Alidade',
                        url: 'https://tiles.stadiamaps.com/tiles/alidade_smooth/{z}/{x}/{y}{r}.png',
                        attribution: '&copy; <a href="https://stadiamaps.com/">Stadia Maps</a>, &copy; <a href="https://openmaptiles.org/">OpenMapTiles</a> &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors'
                    },
                    esri: {
                        name: 'Esri World Imagery',
                        url: 'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',
                        attribution: 'Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community'
                    }
                };
                
                // 城市排名数据
                const cityRankings = ref([
                    { name: '哥本哈根', country: '丹麦', greenIndex: 89.5, emissions: 1.8, renewable: 85, lat: 55.6761, lng: 12.5683 },
                    { name: '斯德哥尔摩', country: '瑞典', greenIndex: 88.2, emissions: 2.0, renewable: 82, lat: 59.3293, lng: 18.0686 },
                    { name: '奥斯陆', country: '挪威', greenIndex: 87.8, emissions: 2.1, renewable: 99, lat: 59.9139, lng: 10.7522 },
                    { name: '赫尔辛基', country: '芬兰', greenIndex: 86.3, emissions: 2.3, renewable: 55, lat: 60.1699, lng: 24.9384 },
                    { name: '阿姆斯特丹', country: '荷兰', greenIndex: 85.7, emissions: 2.5, renewable: 35, lat: 52.3676, lng: 4.9041 },
                    { name: '柏林', country: '德国', greenIndex: 84.2, emissions: 2.8, renewable: 52, lat: 52.5200, lng: 13.4050 },
                    { name: '温哥华', country: '加拿大', greenIndex: 83.9, emissions: 2.7, renewable: 95, lat: 49.2827, lng: -123.1207 },
                    { name: '新加坡', country: '新加坡', greenIndex: 82.1, emissions: 3.5, renewable: 8, lat: 1.3521, lng: 103.8198 },
                    { name: '东京', country: '日本', greenIndex: 81.3, emissions: 3.8, renewable: 25, lat: 35.6762, lng: 139.6503 },
                    { name: '首尔', country: '韩国', greenIndex: 80.5, emissions: 4.2, renewable: 12, lat: 37.5665, lng: 126.9780 }
                ]);
                
                // 地图数据点
                const mapDataPoints = ref([
                    // 亚洲
                    { name: '北京', country: '中国', lat: 39.9042, lng: 116.4074, emissions: 7.8, renewable: 18, greenIndex: 72 },
                    { name: '东京', country: '日本', lat: 35.6762, lng: 139.6503, emissions: 6.8, renewable: 25, greenIndex: 81.3 },
                    { name: '新德里', country: '印度', lat: 28.6139, lng: 77.2090, emissions: 8.5, renewable: 12, greenIndex: 58 },
                    { name: '新加坡', country: '新加坡', lat: 1.3521, lng: 103.8198, emissions: 3.5, renewable: 8, greenIndex: 82.1 },
                    { name: '首尔', country: '韩国', lat: 37.5665, lng: 126.9780, emissions: 4.2, renewable: 12, greenIndex: 80.5 },
                    { name: '曼谷', country: '泰国', lat: 13.7563, lng: 100.5018, emissions: 6.2, renewable: 20, greenIndex: 68 },
                    
                    // 欧洲
                    { name: '伦敦', country: '英国', lat: 51.5074, lng: -0.1278, emissions: 4.2, renewable: 42, greenIndex: 82 },
                    { name: '巴黎', country: '法国', lat: 48.8566, lng: 2.3522, emissions: 2.8, renewable: 32, greenIndex: 80 },
                    { name: '柏林', country: '德国', lat: 52.5200, lng: 13.4050, emissions: 2.8, renewable: 52, greenIndex: 84.2 },
                    { name: '莫斯科', country: '俄罗斯', lat: 55.7558, lng: 37.6173, emissions: 5.8, renewable: 8, greenIndex: 62 },
                    { name: '罗马', country: '意大利', lat: 41.9028, lng: 12.4964, emissions: 4.0, renewable: 25, greenIndex: 75 },
                    { name: '哥本哈根', country: '丹麦', lat: 55.6761, lng: 12.5683, emissions: 1.8, renewable: 85, greenIndex: 89.5 },
                    { name: '奥斯陆', country: '挪威', lat: 59.9139, lng: 10.7522, emissions: 2.1, renewable: 99, greenIndex: 87.8 },
                    { name: '斯德哥尔摩', country: '瑞典', lat: 59.3293, lng: 18.0686, emissions: 2.0, renewable: 82, greenIndex: 88.2 },
                    { name: '赫尔辛基', country: '芬兰', lat: 60.1699, lng: 24.9384, emissions: 2.3, renewable: 55, greenIndex: 86.3 },
                    { name: '阿姆斯特丹', country: '荷兰', lat: 52.3676, lng: 4.9041, emissions: 2.5, renewable: 35, greenIndex: 85.7 },
                    
                    // 北美洲
                    { name: '纽约', country: '美国', lat: 40.7128, lng: -74.0060, emissions: 6.5, renewable: 25, greenIndex: 78 },
                    { name: '洛杉矶', country: '美国', lat: 34.0522, lng: -118.2437, emissions: 5.8, renewable: 28, greenIndex: 76 },
                    { name: '温哥华', country: '加拿大', lat: 49.2827, lng: -123.1207, emissions: 2.7, renewable: 95, greenIndex: 83.9 },
                    { name: '墨西哥城', country: '墨西哥', lat: 19.4326, lng: -99.1332, emissions: 5.2, renewable: 30, greenIndex: 70 },
                    
                    // 南美洲
                    { name: '圣保罗', country: '巴西', lat: -23.5505, lng: -46.6333, emissions: 4.5, renewable: 52, greenIndex: 73 },
                    { name: '布宜诺斯艾利斯', country: '阿根廷', lat: -34.6037, lng: -58.3816, emissions: 4.2, renewable: 35, greenIndex: 76 },
                    
                    // 大洋洲
                    { name: '悉尼', country: '澳大利亚', lat: -33.8688, lng: 151.2093, emissions: 5.2, renewable: 28, greenIndex: 79 },
                    { name: '奥克兰', country: '新西兰', lat: -36.8485, lng: 174.7633, emissions: 3.8, renewable: 45, greenIndex: 82 },
                    
                    // 非洲
                    { name: '开罗', country: '埃及', lat: 30.0444, lng: 31.2357, emissions: 6.2, renewable: 18, greenIndex: 60 },
                    { name: '内罗毕', country: '肯尼亚', lat: -1.2921, lng: 36.8219, emissions: 3.0, renewable: 42, greenIndex: 72 },
                    { name: '拉各斯', country: '尼日利亚', lat: 6.5244, lng: 3.3792, emissions: 6.8, renewable: 15, greenIndex: 55 },
                    { name: '约翰内斯堡', country: '南非', lat: -26.2041, lng: 28.0473, emissions: 5.8, renewable: 22, greenIndex: 65 }
                ]);
                
                // 计算属性
                const legendItems = computed(() => {
                    if (selectedDataType.value === 'emissions') {
                        return [
                            { color: '#1a9850', label: '低 (< 3 吨/人)' },
                            { color: '#91cf60', label: '中低 (3-5 吨/人)' },
                            { color: '#d9ef8b', label: '中 (5-7 吨/人)' },
                            { color: '#fee08b', label: '中高 (7-9 吨/人)' },
                            { color: '#fc8d59', label: '高 (> 9 吨/人)' }
                        ];
                    } else if (selectedDataType.value === 'renewable') {
                        return [
                            { color: '#fc8d59', label: '低 (< 15%)' },
                            { color: '#fee08b', label: '中低 (15-35%)' },
                            { color: '#d9ef8b', label: '中 (35-55%)' },
                            { color: '#91cf60', label: '中高 (55-75%)' },
                            { color: '#1a9850', label: '高 (> 75%)' }
                        ];
                    } else {
                        return [
                            { color: '#fc8d59', label: '低 (< 65)' },
                            { color: '#fee08b', label: '中低 (65-75)' },
                            { color: '#d9ef8b', label: '中 (75-80)' },
                            { color: '#91cf60', label: '中高 (80-85)' },
                            { color: '#1a9850', label: '高 (> 85)' }
                        ];
                    }
                });
                
                // 方法
                const getRankingClass = (rank) => {
                    if (rank === 1) return 'bg-yellow-100 text-yellow-800';
                    if (rank === 2) return 'bg-gray-100 text-gray-800';
                    if (rank === 3) return 'bg-orange-100 text-orange-800';
                    return 'bg-blue-100 text-blue-800';
                };
                
                const getLegendTitle = () => {
                    if (selectedDataType.value === 'emissions') return '碳排放 (吨/人) 2024';
                    if (selectedDataType.value === 'renewable') return '可再生能源占比 (%) 2024';
                    return '绿色指数 2024';
                };
                
                const getColorByValue = (value, type) => {
                    if (type === 'emissions') {
                        if (value < 3) return '#1a9850';
                        if (value < 5) return '#91cf60';
                        if (value < 7) return '#d9ef8b';
                        if (value < 9) return '#fee08b';
                        return '#fc8d59';
                    } else if (type === 'renewable') {
                        if (value < 15) return '#fc8d59';
                        if (value < 35) return '#fee08b';
                        if (value < 55) return '#d9ef8b';
                        if (value < 75) return '#91cf60';
                        return '#1a9850';
                    } else {
                        if (value < 65) return '#fc8d59';
                        if (value < 75) return '#fee08b';
                        if (value < 80) return '#d9ef8b';
                        if (value < 85) return '#91cf60';
                        return '#1a9850';
                    }
                };
                
                const getFallbackX = (lng) => {
                    return ((lng + 180) / 360) * 100;
                };
                
                const getFallbackY = (lat) => {
                    return ((90 - lat) / 180) * 100;
                };
                
                const updateMap = () => {
                    if (worldMap && mapState.value === 'loaded') {
                        // 清除现有标记
                        cityMarkers.forEach(marker => {
                            worldMap.removeLayer(marker);
                        });
                        cityMarkers = [];
                        
                        // 添加更新颜色的标记
                        mapDataPoints.value.forEach(point => {
                            const color = getColorByValue(point[selectedDataType.value], selectedDataType.value);
                            
                            const customIcon = L.divIcon({
                                className: 'custom-marker',
                                html: `<div style="background-color: ${color}; width: 12px; height: 12px; border-radius: 50%; border: 2px solid white; box-shadow: 0 0 5px rgba(0,0,0,0.5);"></div>`,
                                iconSize: [16, 16],
                                iconAnchor: [8, 8]
                            });
                            
                            const marker = L.marker([point.lat, point.lng], { icon: customIcon })
                                .addTo(worldMap)
                                .bindPopup(`
                                    <div class="custom-popup">
                                        <h4 class="font-bold">${point.name}, ${point.country}</h4>
                                        <p>碳排放: ${point.emissions} 吨/人</p>
                                        <p>可再生能源: ${point.renewable}%</p>
                                        <p>绿色指数: ${point.greenIndex}</p>
                                        <p class="text-xs text-gray-500 mt-1">2024年数据</p>
                                    </div>
                                `);
                            
                            cityMarkers.push(marker);
                        });
                    }
                };
                
                const changeMapSource = () => {
                    if (worldMap && mapState.value === 'loaded') {
                        // 移除当前瓦片图层
                        if (currentTileLayer) {
                            worldMap.removeLayer(currentTileLayer);
                        }
                        
                        // 添加新的瓦片图层
                        const source = mapSources[selectedMapSource.value];
                        currentTileLayer = L.tileLayer(source.url, {
                            attribution: source.attribution,
                            maxZoom: 18
                        }).addTo(worldMap);
                    }
                };
                
                const showTooltip = (point, event) => {
                    const rect = event.target.getBoundingClientRect();
                    tooltip.value = {
                        visible: true,
                        x: event.clientX + 10,
                        y: event.clientY - 50,
                        name: point.name,
                        country: point.country,
                        emissions: point.emissions,
                        renewable: point.renewable,
                        greenIndex: point.greenIndex
                    };
                };
                
                const hideTooltip = () => {
                    tooltip.value.visible = false;
                };
                
                // 初始化 Leaflet 地图
                const initMap = () => {
                    mapState.value = 'loading';
                    
                    if (typeof L === 'undefined') {
                        console.error('Leaflet 库加载失败');
                        mapState.value = 'fallback';
                        return;
                    }
                    
                    try {
                        // 创建地图
                        worldMap = L.map('worldMap').setView([20, 0], 2);
                        
                        // 按顺序尝试多个地图源
                        const tryMapSource = (sources, index = 0) => {
                            if (index >= sources.length) {
                                // 所有源都失败，使用备用方案
                                mapState.value = 'fallback';
                                return;
                            }
                            
                            const sourceKey = sources[index];
                            const source = mapSources[sourceKey];
                            
                            console.log(`尝试地图源: ${source.name}`);
                            
                            const tileLayer = L.tileLayer(source.url, {
                                attribution: source.attribution,
                                maxZoom: 18
                            }).addTo(worldMap);
                            
                            currentTileLayer = tileLayer;
                            selectedMapSource.value = sourceKey;
                            
                            // 设置错误处理
                            tileLayer.on('tileerror', function(error) {
                                console.warn(`从 ${source.name} 加载瓦片失败，尝试下一个源`);
                                worldMap.removeLayer(tileLayer);
                                tryMapSource(sources, index + 1);
                            });
                            
                            // 设置成功处理
                            worldMap.whenReady(function() {
                                console.log(`成功从 ${source.name} 加载地图`);
                                mapState.value = 'loaded';
                                updateMap();
                            });
                            
                            // 设置此源的超时
                            setTimeout(() => {
                                if (mapState.value === 'loading') {
                                    console.warn(`加载 ${source.name} 超时，尝试下一个源`);
                                    worldMap.removeLayer(tileLayer);
                                    tryMapSource(sources, index + 1);
                                }
                            }, 3000);
                        };
                        
                        // 按可靠性顺序尝试源
                        const sourceOrder = ['osm', 'carto', 'stadia', 'esri'];
                        tryMapSource(sourceOrder);
                        
                    } catch (error) {
                        console.error('初始化地图时出错:', error);
                        mapState.value = 'fallback';
                    }
                };
                
                // 初始化图表
                const initCharts = () => {
                    // 碳排放图表
                    const emissionsCtx = document.getElementById('emissionsChart').getContext('2d');
                    new Chart(emissionsCtx, {
                        type: 'bar',
                        data: {
                            labels: ['中国', '美国', '印度', '俄罗斯', '日本', '德国', '韩国', '伊朗', '沙特阿拉伯', '加拿大'],
                            datasets: [{
                                label: '碳排放 (百万吨)',
                                data: [11200, 4850, 2980, 1820, 1080, 680, 620, 580, 550, 520],
                                backgroundColor: 'rgba(46, 125, 50, 0.7)',
                                borderColor: 'rgba(46, 125, 50, 1)',
                                borderWidth: 1
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    title: {
                                        display: true,
                                        text: '碳排放 (百万吨)'
                                    }
                                }
                            },
                            plugins: {
                                legend: {
                                    display: false
                                },
                                title: {
                                    display: true,
                                    text: '2024年碳排放前十国家'
                                }
                            }
                        }
                    });
                    
                    // 可再生能源图表
                    const renewableCtx = document.getElementById('renewableChart').getContext('2d');
                    new Chart(renewableCtx, {
                        type: 'line',
                        data: {
                            labels: ['2018', '2019', '2020', '2021', '2022', '2023', '2024'],
                            datasets: [
                                {
                                    label: '太阳能',
                                    data: [8.2, 10.5, 13.8, 18.2, 22.5, 28.3, 34.2],
                                    borderColor: 'rgba(255, 193, 7, 1)',
                                    backgroundColor: 'rgba(255, 193, 7, 0.1)',
                                    tension: 0.3,
                                    fill: true
                                },
                                {
                                    label: '风能',
                                    data: [12.3, 14.8, 16.5, 18.9, 21.4, 24.2, 27.8],
                                    borderColor: 'rgba(139, 195, 74, 1)',
                                    backgroundColor: 'rgba(139, 195, 74, 0.1)',
                                    tension: 0.3,
                                    fill: true
                                }
                            ]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    title: {
                                        display: true,
                                        text: '发电占比 (%)'
                                    }
                                }
                            }
                        }
                    });
                };
                
                // 生命周期
                onMounted(() => {
                    initCharts();
                    initMap();
                });
                
                // 监听数据类型变化
                watch(selectedDataType, () => {
                    if (worldMap && mapState.value === 'loaded') {
                        updateMap();
                    }
                });
                
                return {
                    selectedDataType,
                    selectedMapSource,
                    cityRankings,
                    mapDataPoints,
                    legendItems,
                    mapState,
                    tooltip,
                    getRankingClass,
                    getLegendTitle,
                    updateMap,
                    changeMapSource,
                    initMap,
                    getColorByValue,
                    getFallbackX,
                    getFallbackY,
                    showTooltip,
                    hideTooltip
                };
            }
        }).mount('#app');

        function toggleMenu() {
            const menu = document.getElementById('mobileMenu');
            menu.classList.toggle('hidden');
        }
    </script>
</body>
</html>
